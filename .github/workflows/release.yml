name: Build and Release dlpxdbprofiler

permissions:
  contents: write

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  # -------------------------------------------------
  # Matrix build on GitHub-hosted runners
  #   - ubuntu-latest  -> dlpxdbprofiler-linux-glibc2.38
  #   - macos-latest   -> dlpxdbprofiler-macos
  #   - windows-latest -> dlpxdbprofiler-win64.exe
  # -------------------------------------------------
  build:
    name: Build binaries (GitHub-hosted)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Verify oracledb version (must be <2.0 for CentOS 7 compatibility)
        shell: bash
        run: |
          python -c "import oracledb; print(f'oracledb version: {oracledb.__version__}'); assert oracledb.__version__.startswith('1.'), f'ERROR: oracledb {oracledb.__version__} detected, must be 1.x for CentOS 7 compatibility'"

      - name: Build with PyInstaller using spec file
        shell: bash
        run: |
          pyinstaller dlpxdbprofiler.spec

      - name: Test binary (--version and --help)
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            echo "Testing Windows binary..."
            ./dist/dlpxdbprofiler.exe --version
            ./dist/dlpxdbprofiler.exe --help
          else
            echo "Testing binary..."
            chmod +x dist/dlpxdbprofiler
            ./dist/dlpxdbprofiler --version
            ./dist/dlpxdbprofiler --help
          fi
          echo "✅ Binary test passed!"

      - name: Rename binary per OS
        shell: bash
        run: |
          mkdir -p artifacts
          if [ "${{ runner.os }}" = "Windows" ]; then
            mv dist/dlpxdbprofiler.exe artifacts/dlpxdbprofiler-win64.exe
          elif [ "${{ runner.os }}" = "macOS" ]; then
            mv dist/dlpxdbprofiler artifacts/dlpxdbprofiler-macos
          else
            # Ubuntu / modern Linux (glibc >= 2.38)
            mv dist/dlpxdbprofiler artifacts/dlpxdbprofiler-linux-glibc2.38
          fi

      - name: Upload Windows artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: dlpxdbprofiler-win64
          path: artifacts/dlpxdbprofiler-win64.exe

      - name: Upload macOS artifact
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: dlpxdbprofiler-macos
          path: artifacts/dlpxdbprofiler-macos

      - name: Upload Linux (modern/glibc2.38) artifact
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: dlpxdbprofiler-linux-glibc2.38
          path: artifacts/dlpxdbprofiler-linux-glibc2.38

  # -------------------------------------------------
  # Portable Linux build (glibc 2.28 baseline)
  #   - Target: RHEL8/CentOS Stream 8+ (glibc 2.28)
  #   - Uses manylinux_2_28 + micromamba Python (shared libpython)
  #   -> dlpxdbprofiler-linux
  # -------------------------------------------------
  build-portable-linux:
    name: Build binary (portable Linux / glibc2.28)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Linux binary (glibc 2.28) using micromamba Python
        shell: bash
        run: |
          set -euo pipefail

          docker run -i --rm \
            -v "${{ github.workspace }}:/src" \
            -w /src \
            quay.io/pypa/manylinux_2_28_x86_64:latest \
            /bin/bash <<'BASH'
          set -euo pipefail

          curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba

          # Install Python, PyInstaller, OpenSSL 3.0, and cryptography from conda-forge
          # This ensures cryptography is built against conda's OpenSSL 3.0, not a newer bundled version
          # Pin cryptography to 41.x which is compatible with OpenSSL 3.0.x
          ./bin/micromamba create -y -p /opt/mambaenv -c conda-forge python=3.11 pyinstaller "openssl=3.0.*" "cryptography>=41.0,<42.0" cffi

          ./bin/micromamba run -p /opt/mambaenv python -m pip install -U pip setuptools wheel
          ./bin/micromamba run -p /opt/mambaenv python -m pip install -r requirements.txt

          # Verify OpenSSL version (must be 3.0.x for manylinux_2_28 compatibility)
          ./bin/micromamba run -p /opt/mambaenv python -c "import ssl; print(f'OpenSSL version: {ssl.OPENSSL_VERSION}'); assert '3.0.' in ssl.OPENSSL_VERSION, f'ERROR: OpenSSL {ssl.OPENSSL_VERSION} detected, must be 3.0.x for glibc 2.28 compatibility'"

          # Verify cryptography can be imported and check its OpenSSL version
          ./bin/micromamba run -p /opt/mambaenv python -c "import cryptography; from cryptography.hazmat.backends import default_backend; print(f'cryptography version: {cryptography.__version__}'); print(f'cryptography backend: {default_backend()}')"

          # Verify oracledb version (must be <2.0 for CentOS 7 compatibility)
          ./bin/micromamba run -p /opt/mambaenv python -c "import oracledb; print(f'oracledb version: {oracledb.__version__}'); assert oracledb.__version__.startswith('1.'), f'ERROR: oracledb {oracledb.__version__} detected, must be 1.x for CentOS 7 compatibility'"

          # Verify oracledb can detect cryptography (required for thin mode)
          ./bin/micromamba run -p /opt/mambaenv python -c "import oracledb; print('Testing oracledb thin mode cryptography support...'); import cryptography; print('✅ cryptography is available for oracledb')"

          # Patch PyInstaller conda hook to tolerate missing "depends" key
          ./bin/micromamba run -p /opt/mambaenv python - <<'PY'
          import pathlib, re, sys

          p = pathlib.Path("/opt/mambaenv/lib/python3.11/site-packages/PyInstaller/utils/hooks/conda.py")
          t = p.read_text()

          # Match both single and double quotes around depends
          pat = r'for\s+dependency\s+in\s+self\.raw\[(\"|\x27)depends\1\]\s*:'
          repl = 'for dependency in self.raw.get("depends", []):'

          t2, n = re.subn(pat, repl, t)
          print("conda.py:", p)
          if n == 0:
              print("Patch failed. Showing lines containing 'depends':")
              for i, line in enumerate(t.splitlines(), start=1):
                  if "depends" in line:
                      print(f"{i}: {line}")
              sys.exit(1)

          p.write_text(t2)
          print("Patched OK (replacements):", n)
          PY

          ./bin/micromamba run -p /opt/mambaenv python -m PyInstaller --clean --noconfirm dlpxdbprofiler.spec

          # Test the binary before packaging
          echo "Testing portable Linux binary..."
          chmod +x /src/dist/dlpxdbprofiler
          /src/dist/dlpxdbprofiler --version
          /src/dist/dlpxdbprofiler --help
          echo "✅ Binary test passed!"

          mkdir -p /src/artifacts
          mv /src/dist/dlpxdbprofiler /src/artifacts/dlpxdbprofiler-linux
          BASH
          
          # Host-side check (fails job if file missing)
          ls -lah artifacts || true
          test -f artifacts/dlpxdbprofiler-linux

      - name: Upload portable Linux artifact (glibc2.28)
        uses: actions/upload-artifact@v4
        with:
          name: dlpxdbprofiler-linux
          path: artifacts/dlpxdbprofiler-linux

  # -------------------------------------------------
  # Release job: creates GitHub Release and attaches
  # all binaries from all build jobs.
  # -------------------------------------------------
  release:
    name: Create GitHub Release
    needs:
      - build
      - build-portable-linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/dlpxdbprofiler-linux/dlpxdbprofiler-linux
            dist/dlpxdbprofiler-linux-glibc2.38/dlpxdbprofiler-linux-glibc2.38
            dist/dlpxdbprofiler-macos/dlpxdbprofiler-macos
            dist/dlpxdbprofiler-win64/dlpxdbprofiler-win64.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
